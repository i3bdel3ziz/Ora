<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timesheet — Monthly Hours (V1.7)</title>
  <meta name="description" content="Timesheet: Sun–Thu workweek (Fri+Sat weekend), fixed 8h/day, one long day at 9.5h, CSV/PDF export, trend chart, progress ring, JSON backup, mobile banner, quick month jump." />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    noscript{display:block;padding:1rem;background:#fee2e2;color:#7f1d1d;margin:1rem;border-radius:.5rem}
    @media (max-width: 640px){
      #totalsBar{position:fixed;left:0;right:0;bottom:0;z-index:30;background:#111;color:#fff;padding:.5rem .75rem;display:flex;gap:.75rem;justify-content:space-between;align-items:center}
      body{padding-bottom:58px;}
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <noscript>This app requires JavaScript. Please enable it and reload.</noscript>
  <div id="root"></div>

  <!-- React + ReactDOM (production UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for in-browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useState, useRef } = React;

    // Utilities
    function daysInMonth(year, monthIndex0) { return new Date(year, monthIndex0 + 1, 0).getDate(); }
    function fmt(n) { return (Math.round(n * 100) / 100).toFixed(2); }
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    const WEEKDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const STORAGE_KEY = 'timesheet-v1.7';

    function TrendChart({ data, target }){
      const width = Math.max(260, data.length*14 + 40);
      const height = 120;
      const padL = 28, padB = 18, padT = 10, padR = 10;
      const innerW = width - padL - padR;
      const innerH = height - padT - padB;
      const maxY = Math.max(target*1.1, ...data.map(d=>d.hours))*1.1 || target || 8;
      const barW = Math.max(6, innerW / Math.max(1,data.length) * 0.7);
      const step = innerW / Math.max(1,data.length);
      const ty = height - padB - innerH * clamp(target/maxY, 0, 1);

      return (
        <svg viewBox={"0 0 " + width + " " + height} className="w-full h-28">
          <line x1={padL} y1={ty} x2={width-padR} y2={ty} className="stroke-gray-400" strokeDasharray="4 3" />
          {data.map((d, idx)=>{
            const x = padL + step*idx + (step-barW)/2;
            const h = innerH * clamp(d.hours/maxY, 0, 1);
            const y = height - padB - h;
            const over = d.hours >= target;
            return <rect key={idx} x={x} y={y} width={barW} height={h} rx="2" className={over? 'fill-green-600':'fill-amber-600'} />;
          })}
        </svg>
      );
    }

    function ProgressRing({ actual, target }){
      const pct = target>0 ? clamp(actual/target,0,1) : 0;
      const size=120, stroke=12, r=(size-stroke)/2, c=2*Math.PI*r;
      const dash = c*pct;
      return (
        <svg viewBox={"0 0 " + size + " " + size} className="w-28 h-28">
          <circle cx={size/2} cy={size/2} r={r} strokeWidth={stroke} className="fill-none stroke-gray-200"/>
          <circle cx={size/2} cy={size/2} r={r} strokeWidth={stroke} className="fill-none stroke-indigo-600" strokeLinecap="round"
            strokeDasharray={dash + " " + (c-dash)} transform={"rotate(-90 " + (size/2) + " " + (size/2) + ")"} />
          <text x="50%" y="50%" dominantBaseline="middle" textAnchor="middle" className="fill-current text-sm">{Math.round(pct*100)}%</text>
        </svg>
      );
    }

    function App(){
      const today = new Date();
      const [year, setYear] = useState(today.getFullYear());
      const [month, setMonth] = useState(today.getMonth()); // 0..11
      const [hoursByDay, setHoursByDay] = useState({}); // { dayNumber: number }

      const dailyTarget = 8; // fixed
      const weekendDays = new Set([5,6]); // Fri + Sat

      // Long day (Sun..Thu = 0..4)
      const [longDay, setLongDay] = useState(0);
      const longHours = 9.5;

      // File input ref for JSON restore
      const fileRef = useRef(null);

      // Load & Save
      useEffect(()=>{
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            const p = JSON.parse(raw);
            if(typeof p.year==='number') setYear(p.year);
            if(typeof p.month==='number') setMonth(p.month);
            setHoursByDay(p.hoursByDay || {});
            if(typeof p.longDay==='number') setLongDay(p.longDay);
          }
        }catch{}
      },[]);
      useEffect(()=>{
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({year, month, hoursByDay, longDay})); }catch{}
      },[year, month, hoursByDay, longDay]);

      const totalDays = daysInMonth(year, month);
      const isWeekend = (wd)=> weekendDays.has(wd);

      // Build Sun-Thu grid rows
      const workCols = useMemo(()=>[0,1,2,3,4],[]); // Sun..Thu
      const rows = useMemo(()=>{
        const out=[]; let current=[null,null,null,null,null,null,null];
        for(let d=1; d<=totalDays; d++){
          const wd = new Date(year, month, d).getDay();
          if(isWeekend(wd)) continue;
          if(wd===0 && current.some(c=>c!==null)){ out.push(current); current=[null,null,null,null,null,null,null]; }
          current[wd] = d;
          const nextDate = new Date(year, month, d+1);
          const nextIsNewWeek = nextDate.getDay()===0 || d===totalDays;
          if(nextIsNewWeek){ out.push(current); current=[null,null,null,null,null,null,null]; }
        }
        if(current.some(c=>c!==null)) out.push(current);
        return out.map(row => workCols.map(wd => row[wd] ?? null));
      },[year, month, totalDays]);

      const workingDays = useMemo(()=> rows.flat().filter(Boolean).length, [rows]);
      const targetMonthlyHours = workingDays * dailyTarget; // target stays 8h per working day
      const actualMonthlyHours = useMemo(()=> Object.values(hoursByDay).reduce((s,v)=> s + (Number(v)||0), 0), [hoursByDay]);
      const diff = actualMonthlyHours - targetMonthlyHours;
      const pct = targetMonthlyHours>0 ? (actualMonthlyHours/targetMonthlyHours)*100 : 0;
      const monthLabel = useMemo(()=> new Date(year,month,1).toLocaleDateString(undefined, {month:'long', year:'numeric'}), [year,month]);

      // Color-coded summary
      function summaryClass(){
        if (pct >= 100) return 'bg-green-50 text-green-700';
        if (pct >= 90) return 'bg-amber-50 text-amber-700';
        return 'bg-red-50 text-red-700';
      }

      function goPrevMonth(){ const m=month-1; if(m<0){ setMonth(11); setYear(y=>y-1);} else setMonth(m); }
      function goNextMonth(){ const m=month+1; if(m>11){ setMonth(0); setYear(y=>y+1);} else setMonth(m); }
      function resetToCurrent(){ const n=new Date(); setYear(n.getFullYear()); setMonth(n.getMonth()); }

      // Quick jump select (last 24 months + next 12)
      const jumpOptions = useMemo(()=>{
        const list=[];
        for(let k=-24; k<=12; k++){
          const dt=new Date(today.getFullYear(), today.getMonth()+k, 1);
          const val=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0');
          list.push({val, label: dt.toLocaleDateString(undefined,{month:'long', year:'numeric'})});
        }
        return list;
      },[]);
      function onJumpChange(e){
        const [y,m] = e.target.value.split('-').map(Number);
        setYear(y); setMonth(m-1);
      }
      const currentYM = year+'-'+String(month+1).padStart(2,'0');

      // CSV Export
      function exportCSV(){
        const lines = ["day,weekday,hours"];
        for(let d=1; d<=totalDays; d++){
          const wd = new Date(year, month, d).getDay();
          if(isWeekend(wd)) continue;
          const wk = WEEKDAYS[wd];
          const v = hoursByDay[d] ?? '';
          lines.push(`${d},${wk},${v}`);
        }
        const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `timesheet_${year}_${String(month+1).padStart(2,'0')}.csv`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // JSON Backup/Restore
      function exportJSON(){
        const payload = { year, month, hoursByDay, longDay, version: '1.7', exportedAt: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(payload,null,2)], { type:'application/json;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `timesheet_backup_${year}_${String(month+1).padStart(2,'0')}.json`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function importJSON(file){
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const obj = JSON.parse(reader.result);
            if(typeof obj.year==='number') setYear(obj.year);
            if(typeof obj.month==='number') setMonth(obj.month);
            if(obj && typeof obj.hoursByDay==='object') setHoursByDay(obj.hoursByDay);
            if(typeof obj.longDay==='number') setLongDay(obj.longDay);
          }catch(err){
            alert('Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }

      // PDF Export - avoid literal closing tag for the outer script
      function exportPDF(){
        const w = window.open('', '_blank', 'noopener,noreferrer,width=900,height=700'); if(!w) return;
        const style = 'body{font-family:sans-serif;margin:24px;color:#111}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:6px;font-size:12px;text-align:right}th:first-child,td:first-child{text-align:left}';
        const monthName = new Date(year,month,1).toLocaleDateString(undefined,{month:'long', year:'numeric'});
        let rowsHtml = '';
        for(let d=1; d<=totalDays; d++){
          const wd = new Date(year,month,d).getDay(); if(isWeekend(wd)) continue;
          const wk = WEEKDAYS[wd]; const v = hoursByDay[d] ?? '';
          rowsHtml += '<tr><td>'+wk+' '+d+'</td><td>'+(v!==''?Number(v).toFixed(2):'')+'</td></tr>';
        }
        const summary = '<table><thead><tr><th>Metric</th><th>Value (h)</th></tr></thead><tbody>'
          + '<tr><td>Target hours</td><td>'+ (targetMonthlyHours).toFixed(2) +'</td></tr>'
          + '<tr><td>Actual hours</td><td>'+ (actualMonthlyHours).toFixed(2) +'</td></tr>'
          + '<tr><td>'+(diff>=0?'Exceed':'Shortage')+'</td><td>'+ Math.abs(diff).toFixed(2) +'</td></tr>'
          + '</tbody></table>';
        const printScript = '<scr' + 'ipt>window.onload=()=>window.print()<\/scr' + 'ipt>';
        const html = '<!doctype html><html><head><meta charset="utf-8"><title>Timesheet Report</title><style>'+style+'</style></head>'
          + '<body><h1>Timesheet Report — '+monthName+'</h1>'+summary
          + '<h2>Daily entries (Sun–Thu)</h2><table><thead><tr><th>Day</th><th>Hours</th></tr></thead><tbody>'+rowsHtml+'</tbody></table>'
          + printScript + '</body></html>';
        w.document.open(); w.document.write(html); w.document.close();
      }

      // Bulk helpers
      function fillAllWorking(){
        const next = { ...hoursByDay };
        rows.forEach(row => row.forEach(d => {
          if (!d) return;
          const wd = new Date(year, month, d).getDay(); // 0..6
          next[d] = (wd === longDay) ? 9.5 : 8;
        }));
        setHoursByDay(next);
      }
      function clearAll(){ setHoursByDay({}); }

      // Chart data
      const chartData = useMemo(()=>{
        const d=[];
        rows.forEach(row=> row.forEach(dayNum=> { if(dayNum) d.push({day: dayNum, hours: Number(hoursByDay[dayNum])||0}); }));
        d.sort((a,b)=>a.day-b.day);
        return d;
      },[rows, hoursByDay]);

      return (
        <div className="min-h-screen w-full">
          <div className="max-w-6xl mx-auto p-6">
            {/* Header */}
            <header className="mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
              <div className="flex items-center gap-2">
                <button onClick={goPrevMonth} className="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">◀</button>
                <h1 className="text-2xl font-bold min-w-[220px] text-center">{monthLabel}</h1>
                <span className="ml-2 inline-block px-2 py-1 text-xs font-semibold bg-indigo-100 text-indigo-700 rounded-full">v1.7</span>
                <button onClick={goNextMonth} className="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">▶</button>
              </div>
              <div className="flex flex-wrap gap-3 items-center">
                {/* Long day select */}
                <label className="text-sm flex items-center gap-2">
                  <span>Long day</span>
                  <select
                    value={longDay}
                    onChange={(e)=>setLongDay(Number(e.target.value))}
                    className="rounded-lg border px-3 py-2 bg-white"
                  >
                    {[0,1,2,3,4].map(i => (
                      <option key={i} value={i}>{WEEKDAYS[i]}</option>
                    ))}
                  </select>
                  <span className="text-xs text-gray-500">(9.5 h)</span>
                </label>

                {/* Quick month jump */}
                <label className="text-sm flex items-center gap-2">
                  <span>Jump</span>
                  <select value={currentYM} onChange={onJumpChange} className="rounded-lg border px-3 py-2 bg-white">
                    {jumpOptions.map(o => (
                      <option key={o.val} value={o.val}>{o.label}</option>
                    ))}
                  </select>
                </label>

                <button onClick={resetToCurrent} className="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Reset</button>
                <button onClick={fillAllWorking} className="px-3 py-2 rounded-xl bg-gray-900 text-white hover:opacity-90">Fill all</button>
                <button onClick={clearAll} className="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Clear all</button>
                <button onClick={exportCSV} className="px-3 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">Export CSV</button>
                <button onClick={exportPDF} className="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Export PDF</button>
                <button onClick={exportJSON} className="px-3 py-2 rounded-xl bg-slate-700 text-white hover:opacity-90">Backup JSON</button>
                <label className="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 cursor-pointer">
                  Restore JSON
                  <input ref={fileRef} type="file" accept="application/json" className="hidden"
                    onChange={(e)=>{ const f=e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; }} />
                </label>
              </div>
            </header>

            {/* Summary */}
            <div className="grid sm:grid-cols-3 gap-3 mb-4">
              <div className="bg-white rounded-xl p-3">
                <div className="text-sm text-gray-600">Target hours</div>
                <div className="text-xl font-bold">{fmt(targetMonthlyHours)}</div>
                <div className="text-xs text-gray-500 mt-1">Working days: {workingDays} × {fmt(8)} h</div>
              </div>
              <div className="bg-white rounded-xl p-3">
                <div className="text-sm text-gray-600">Actual hours</div>
                <div className="text-xl font-bold">{fmt(actualMonthlyHours)}</div>
                <div className="text-xs text-gray-500 mt-1">Sum of daily entries</div>
              </div>
              <div className={summaryClass() + ' rounded-xl p-3'}>
                <div className="flex items-center gap-3">
                  <div className="shrink-0"><ProgressRing actual={actualMonthlyHours} target={targetMonthlyHours} /></div>
                  <div>
                    <div className="text-sm font-semibold">{diff>=0? 'Exceed by':'Shortage of'}</div>
                    <div className="text-xl font-bold">{fmt(Math.abs(diff))} h</div>
                    <div className="text-xs opacity-80 mt-1">Completion: {fmt(pct)}%</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Chart */}
            <div className="bg-white rounded-2xl shadow p-4 mb-4">
              <div className="flex items-center justify-between mb-2">
                <h3 className="font-semibold">Trend — Daily hours (Sun–Thu)</h3>
                <div className="text-xs text-gray-500">Dashed line = 8h target</div>
              </div>
              <TrendChart data={chartData} target={8} />
            </div>

            {/* Day grid */}
            <div className="bg-white rounded-2xl shadow p-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold">Daily entries (Sun–Thu)</h3>
                <div className="text-xs text-gray-500">Friday & Saturday excluded</div>
              </div>

              <div className="grid gap-3">
                {rows.map((row, ri) => {
                  const weekDaysCount = row.filter(Boolean).length || 1;
                  const weekSum = row.reduce((s, d) => s + (d ? (Number(hoursByDay[d])||0) : 0), 0);
                  const weekAvg = weekSum / weekDaysCount;
                  return (
                    <div key={'row'+ri} className="grid gap-2" style={{gridTemplateColumns: 'repeat(' + row.length + ', minmax(0,1fr))'}}>
                      {row.map((dayNum, j) => {
                        const isLongCol = (j === longDay); // visual highlight by column index (Sun..Thu)
                        const highlight = isLongCol ? 'bg-indigo-50' : '';
                        return (
                          <div key={'c'+j} className={'rounded-xl border p-2 ' + highlight}>
                            {dayNum ? (
                              <>
                                <div className="flex items-center justify-between mb-2">
                                  <span className="text-xs text-gray-500">{WEEKDAYS[j]} {dayNum}</span>
                                  {isLongCol && <span title="Long day" className="text-[10px] px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-700">9.5h</span>}
                                </div>
                                <input
                                  type="number"
                                  step="0.25"
                                  min="0"
                                  className="w-full rounded-lg border px-2 py-1"
                                  value={hoursByDay[dayNum] ?? ''}
                                  onChange={(e) => {
                                    const v = e.target.value === '' ? NaN : Number(e.target.value);
                                    setHoursByDay((prev) => {
                                      const next = { ...prev };
                                      if (Number.isNaN(v)) delete next[dayNum]; else next[dayNum] = v;
                                      return next;
                                    });
                                  }}
                                />
                              </>
                            ) : (
                              <div className="h-7 sm:h-10" />
                            )}
                          </div>
                        );
                      })}
                      <div className="col-span-full -mt-1 text-right text-sm text-gray-700 flex items-center justify-end gap-2">
                        <span className="inline-block rounded-lg px-2 py-1 bg-gray-100">Week subtotal: <b>{fmt(weekSum)}</b> h</span>
                        <span className="inline-block rounded-lg px-2 py-1 bg-gray-100">Avg: <b>{fmt(weekAvg)}</b> h/day</span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <footer className="text-xs text-gray-500 mt-6 text-center space-y-1">
              <div>V1.7 - Fixed Qatar weekend (Fri+Sat). 8h daily target with one long day at 9.5h. JSON backup/restore, color-coded summary, mobile totals, quick month jump.</div>
              <div>Built by <a href="https://github.com/i3bdel3ziz/Timesheet_App" target="_blank" rel="noopener noreferrer" className="underline hover:text-indigo-600">i3bdel3ziz</a></div>
            </footer>
          </div>
        </div>

        {/* Mobile sticky totals */}
        <div id="totalsBar" className="hidden sm:hidden">
          <div className="text-xs">Target: <b>{fmt(targetMonthlyHours)}</b>h</div>
          <div className="text-xs">Actual: <b>{fmt(actualMonthlyHours)}</b>h</div>
          <div className="text-xs">{diff>=0?'Exceed':'Shortage'}: <b>{fmt(Math.abs(diff))}</b>h</div>
        </div>
      );
    }

    const mount = document.getElementById('root');
    try {
      const root = ReactDOM.createRoot(mount);
      root.render(React.createElement(App));
    } catch (err) {
      console.error('Render error:', err);
      mount.innerHTML = '<div style="padding:1rem;background:#fee2e2;color:#7f1d1d;border-radius:.5rem;">App failed to load. Open the browser console and share the error message.</div>';
    }
  </script>
</body>
</html>
