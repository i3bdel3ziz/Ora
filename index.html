<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timesheet — Monthly Hours (V1.7)</title>
  <meta name="description" content="Timesheet: Sun–Thu workweek (Fri+Sat weekend), fixed 8h/day, one long day at 9.5h, CSV/PDF export, trend chart, progress ring, JSON backup, mobile banner, quick month jump." />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    noscript{display:block;padding:1rem;background:#fee2e2;color:#7f1d1d;margin:1rem;border-radius:.5rem}
    @media (max-width: 640px){
      #totalsBar{position:fixed;left:0;right:0;bottom:0;z-index:30;background:#111;color:#fff;padding:.5rem .75rem;display:flex;gap:.75rem;justify-content:space-between;align-items:center}
      body{padding-bottom:58px;}
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <noscript>This app requires JavaScript. Please enable it and reload.</noscript>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useState, useRef } = React;

    function daysInMonth(year, monthIndex0) { return new Date(year, monthIndex0 + 1, 0).getDate(); }
    function fmt(n) { return (Math.round(n * 100) / 100).toFixed(2); }
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    const WEEKDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const STORAGE_KEY = 'timesheet-v1.7';

    function App(){
      const today = new Date();
      const [year, setYear] = useState(today.getFullYear());
      const [month, setMonth] = useState(today.getMonth());
      const [hoursByDay, setHoursByDay] = useState({});

      const dailyTarget = 8;
      const weekendDays = new Set([5,6]);

      const [longDay, setLongDay] = useState(0);
      const longHours = 9.5;
      const fileRef = useRef(null);

      useEffect(()=>{
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            const p = JSON.parse(raw);
            if(typeof p.year==='number') setYear(p.year);
            if(typeof p.month==='number') setMonth(p.month);
            setHoursByDay(p.hoursByDay || {});
            if(typeof p.longDay==='number') setLongDay(p.longDay);
          }
        }catch{}
      },[]);
      useEffect(()=>{
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({year, month, hoursByDay, longDay})); }catch{}
      },[year, month, hoursByDay, longDay]);

      const totalDays = daysInMonth(year, month);
      const isWeekend = (wd)=> weekendDays.has(wd);

      const workCols = useMemo(()=>[0,1,2,3,4],[]);
      const rows = useMemo(()=>{
        const out=[]; let current=[null,null,null,null,null,null,null];
        for(let d=1; d<=totalDays; d++){
          const wd = new Date(year, month, d).getDay();
          if(isWeekend(wd)) continue;
          if(wd===0 && current.some(c=>c!==null)){ out.push(current); current=[null,null,null,null,null,null,null]; }
          current[wd] = d;
          const nextDate = new Date(year, month, d+1);
          const nextIsNewWeek = nextDate.getDay()===0 || d===totalDays;
          if(nextIsNewWeek){ out.push(current); current=[null,null,null,null,null,null,null]; }
        }
        if(current.some(c=>c!==null)) out.push(current);
        return out.map(row => workCols.map(wd => row[wd] ?? null));
      },[year, month, totalDays]);

      const workingDays = useMemo(()=> rows.flat().filter(Boolean).length, [rows]);
      const targetMonthlyHours = workingDays * dailyTarget;
      const actualMonthlyHours = useMemo(()=> Object.values(hoursByDay).reduce((s,v)=> s + (Number(v)||0), 0), [hoursByDay]);
      const diff = actualMonthlyHours - targetMonthlyHours;
      const pct = targetMonthlyHours>0 ? (actualMonthlyHours/targetMonthlyHours)*100 : 0;
      const monthLabel = useMemo(()=> new Date(year,month,1).toLocaleDateString(undefined, {month:'long', year:'numeric'}), [year,month]);

      function summaryClass(){
        if (pct >= 100) return 'bg-green-50 text-green-700';
        if (pct >= 90) return 'bg-amber-50 text-amber-700';
        return 'bg-red-50 text-red-700';
      }

      function fillAllWorking(){
        const next = { ...hoursByDay };
        rows.forEach(row => row.forEach(d => {
          if (!d) return;
          const wd = new Date(year, month, d).getDay();
          next[d] = (wd === longDay) ? 9.5 : 8;
        }));
        setHoursByDay(next);
      }
      function clearAll(){ setHoursByDay({}); }

      const chartData = useMemo(()=>{
        const d=[];
        rows.forEach(row=> row.forEach(dayNum=> { if(dayNum) d.push({day: dayNum, hours: Number(hoursByDay[dayNum])||0}); }));
        d.sort((a,b)=>a.day-b.day);
        return d;
      },[rows, hoursByDay]);

      return (<>
        <div className="min-h-screen w-full">
          <div className="max-w-6xl mx-auto p-6">
            <h1 className="text-2xl font-bold">{monthLabel} <span className="ml-2 text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">v1.7</span></h1>
            <button onClick={fillAllWorking} className="px-3 py-2 rounded-xl bg-gray-900 text-white">Fill all</button>
            <button onClick={clearAll} className="px-3 py-2 rounded-xl bg-gray-200">Clear all</button>

            <div className={summaryClass() + ' rounded-xl p-3'}>
              <div>{diff>=0? 'Exceed by':'Shortage of'} {fmt(Math.abs(diff))} h</div>
            </div>

            <div id="totalsBar" className="hidden sm:hidden">
              <div className="text-xs">Target: <b>{fmt(targetMonthlyHours)}</b>h</div>
              <div className="text-xs">Actual: <b>{fmt(actualMonthlyHours)}</b>h</div>
              <div className="text-xs">{diff>=0?'Exceed':'Shortage'}: <b>{fmt(Math.abs(diff))}</b>h</div>
            </div>
          </div>
        </div>
      </>);
    }

    const mount = document.getElementById('root');
    const root = ReactDOM.createRoot(mount);
    root.render(React.createElement(App));
  </script>
</body>
</html>
