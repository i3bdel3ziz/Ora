<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monthly Hours — Shortage / Excess</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;
    function daysInMonth(year, monthIndex0) { return new Date(year, monthIndex0 + 1, 0).getDate(); }
    function fmt(n) { return (Math.round(n * 100) / 100).toFixed(2); }
    function parseHours(text) {
      const s = (typeof text === "string" ? text : "").trim();
      if (s === "") return NaN;
      if (s.includes(":")) {
        let t = s;
        const sign = t.startsWith("-") ? -1 : 1;
        if (t.startsWith("-") || t.startsWith("+")) t = t.slice(1);
        const parts = t.split(":");
        if (parts.length !== 2) return NaN;
        const h = Number(parts[0]);
        const m = Number(parts[1]);
        if (!isFinite(h) || !isFinite(m) || m < 0 || m >= 60) return NaN;
        return sign * (h + m / 60);
      }
      const num = Number(s.replace(",", "."));
      return isFinite(num) ? num : NaN;
    }
    const DEFAULTS = (() => { const now = new Date(); return { YEAR: now.getUTCFullYear(), MONTH: now.getUTCMonth() + 1 }; })();
    function readInitialYearMonth() {
      try {
        const url = new URL(window.location.href);
        const y = url.searchParams.get("year");
        const m = url.searchParams.get("month");
        const year = y ? Number(y) : DEFAULTS.YEAR;
        let month1to12 = m ? Number(m) : DEFAULTS.MONTH;
        if (!Number.isFinite(year)) throw new Error("bad year");
        if (!Number.isFinite(month1to12)) throw new Error("bad month");
        month1to12 = Math.min(12, Math.max(1, Math.round(month1to12)));
        return { year, month0: month1to12 - 1 };
      } catch { const now = new Date(); return { year: now.getFullYear(), month0: now.getMonth() }; }
    }
    const STORAGE_KEY = "hours-calculator-pages-v2";
    const WEEKDAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const WORKING_WEEK = ["Sun","Mon","Tue","Wed","Thu"];
    function App() {
      const init = readInitialYearMonth();
      const [year, setYear] = useState(init.year);
      const [month, setMonth] = useState(init.month0);
      const [hoursByDay, setHoursByDay] = useState({});
      const [shortageText, setShortageText] = useState("");
      useEffect(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const p = JSON.parse(raw);
            setYear(typeof p.year === "number" ? p.year : init.year);
            setMonth(typeof p.month === "number" ? p.month : init.month0);
            setHoursByDay(p.hoursByDay ?? {});
            setShortageText(typeof p.shortageText === "string" ? p.shortageText : "");
          }
        } catch {}
      }, []);
      useEffect(() => {
        const payload = { year, month, hoursByDay, shortageText };
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); } catch {}
      }, [year, month, hoursByDay, shortageText]);
      const totalDays = useMemo(() => daysInMonth(year, month), [year, month]);
      const dayMeta = useMemo(() => {
        const arr = [];
        for (let d = 1; d <= totalDays; d++) {
          const dt = new Date(year, month, d);
          const weekdayIndex = dt.getDay();
          const weekdayKey = WEEKDAYS[weekdayIndex];
          const isWeekend = weekdayKey === "Fri" || weekdayKey === "Sat";
          arr.push({ date: dt, day: d, weekdayIndex, weekdayKey, isWeekend });
        }
        return arr;
      }, [year, month, totalDays]);
      const workingDayMeta = useMemo(() => dayMeta.filter(d => !d.isWeekend), [dayMeta]);
      const workingDays = workingDayMeta.length;
      const targetMonthlyHours = useMemo(() => workingDays * 8, [workingDays]);
      const actualMonthlyHours = useMemo(() => Object.values(hoursByDay).reduce((s, v) => s + (Number(v) || 0), 0), [hoursByDay]);
      const diff = actualMonthlyHours - targetMonthlyHours;
      const shortageValue = useMemo(() => parseHours(shortageText), [shortageText]);
      const shortageInvalid = useMemo(() => shortageText.trim() !== "" && Number.isNaN(shortageValue), [shortageText, shortageValue]);
      const calculatedActualFromShortage = useMemo(() => Number.isNaN(shortageValue) ? NaN : targetMonthlyHours + shortageValue, [shortageValue, targetMonthlyHours]);
      const shortageModeDiff = Number.isNaN(calculatedActualFromShortage) ? NaN : (calculatedActualFromShortage - targetMonthlyHours);
      const remainingToMatch = useMemo(() => Number.isNaN(calculatedActualFromShortage) ? NaN : calculatedActualFromShortage - actualMonthlyHours, [calculatedActualFromShortage, actualMonthlyHours]);
      const monthLabel = useMemo(() => new Date(year, month, 1).toLocaleDateString(undefined, { month: "long", year: "numeric" }), [year, month]);
      function setAllWeekdaysToTarget(){ const next = { ...hoursByDay }; workingDayMeta.forEach(d => { next[d.day] = 8; }); setHoursByDay(next); }
      function clearAll(){ setHoursByDay({}); }
      return (<div className="min-h-screen w-full text-gray-900"><div className="max-w-5xl mx-auto p-6">
        <header className="mb-6"><h1 className="text-2xl font-bold">Monthly Hours — Shortage / Excess</h1><p className="text-sm text-gray-600 mt-1">Enter daily hours; see your total and whether you are short or over the monthly target.</p></header>
        <div className="grid md:grid-cols-2 gap-4 mb-6">
          <div className="bg-white rounded-2xl shadow p-4 space-y-3">
            <div className="grid grid-cols-2 gap-3">
              <label className="flex flex-col text-sm"><span className="font-medium">Month</span>
                <select className="mt-1 rounded-lg border px-3 py-2" value={month} onChange={(e)=>setMonth(Number(e.target.value))}>
                  {Array.from({length:12}).map((_,i)=>(<option key={i} value={i}>{new Date(2020,i,1).toLocaleString(undefined,{month:"long"})}</option>))}
                </select>
              </label>
              <label className="flex flex-col text-sm"><span className="font-medium">Year</span>
                <input type="number" className="mt-1 rounded-lg border px-3 py-2" value={year} onChange={(e)=>setYear(Number(e.target.value))} />
              </label>
            </div>
            <div className="flex gap-2 pt-1">
              <button onClick={setAllWeekdaysToTarget} className="px-3 py-2 rounded-xl bg-gray-900 text-white shadow hover:opacity-90">Fill all</button>
              <button onClick={clearAll} className="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Clear all</button>
            </div>
          </div>
          <div className="bg-white rounded-2xl shadow p-4 h-fit space-y-4">
            <div className="flex items-center justify-between"><h2 className="text-lg font-semibold">Summary — {monthLabel}</h2></div>
            <div className="grid grid-cols-2 gap-3 text-sm">
              <div className="bg-gray-50 rounded-xl p-3"><div className="text-gray-600">Target hours</div><div className="text-xl font-bold">{fmt(targetMonthlyHours)}</div><div className="text-xs text-gray-500 mt-1">Working days (Sun–Thu): {workingDays} × 8 h</div></div>
              <div className="bg-gray-50 rounded-xl p-3"><div className="text-gray-600">Actual hours (from entries)</div><div className="text-xl font-bold">{fmt(actualMonthlyHours)}</div><div className="text-xs text-gray-500 mt-1">Sum of daily entries</div></div>
            </div>
            <div className={diff>=0?"rounded-xl p-3 text-sm font-semibold bg-green-50 text-green-700":"rounded-xl p-3 text-sm font-semibold bg-amber-50 text-amber-700"}>{diff>=0?(<div>Exceed by {fmt(Math.abs(diff))} h</div>):(<div>Shortage of {fmt(Math.abs(diff))} h</div>)}</div>
            <div className="border rounded-2xl p-3 space-y-2">
              <div className="text-sm font-medium">Quick by shortage</div>
              <label className="flex items-center gap-2 text-sm"><span>Enter shortage/exceed:</span>
                <input type="text" inputMode="decimal" aria-invalid={shortageInvalid}
                  className={"rounded-lg border px-3 py-2 w-48 "+(shortageInvalid?'border-red-500 focus:outline-none focus:ring-2 focus:ring-red-400':'')}
                  placeholder="e.g., -5 (shortage), +3 (exceed), 1:30" value={shortageText} onChange={(e)=>setShortageText(e.target.value)} />
              </label>
              {shortageInvalid && (<div className="text-xs text-red-600">Invalid format. Use numbers like <b>-5</b>, <b>+3.5</b> or time like <b>-0:45</b>, <b>1:30</b>.</div>)}
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div className="bg-gray-50 rounded-xl p-3"><div className="text-gray-600">Entered value (h)</div><div className="text-xl font-bold">{Number.isNaN(shortageValue)?"—":fmt(shortageValue)}</div><div className="text-xs text-gray-500 mt-1">- = shortage, + = exceed</div></div>
                <div className="bg-gray-50 rounded-xl p-3"><div className="text-gray-600">Calculated actual</div><div className="text-xl font-bold">{Number.isNaN(calculatedActualFromShortage)?"—":fmt(calculatedActualFromShortage)}</div><div className="text-xs text-gray-500 mt-1">= Target + value</div></div>
              </div>
              {!Number.isNaN(remainingToMatch) && (<div className={remainingToMatch>0?"rounded-xl p-3 text-sm bg-amber-50 text-amber-700":"rounded-xl p-3 text-sm bg-green-50 text-green-700"}>
                {remainingToMatch>0?(<div>Remaining to reach this actual: <b>{fmt(remainingToMatch)}</b> h</div>):(<div>You have already surpassed this actual by <b>{fmt(Math.abs(remainingToMatch))}</b> h</div>)}
              </div>)}
              {!Number.isNaN(shortageModeDiff) && (<div className={shortageModeDiff>=0?"rounded-xl p-3 text-sm font-semibold bg-green-50 text-green-700":"rounded-xl p-3 text-sm font-semibold bg-amber-50 text-amber-700"}>
                {shortageModeDiff>=0?(<div>Exceed by {fmt(Math.abs(shortageModeDiff))} h</div>):(<div>Shortage of {fmt(Math.abs(shortageModeDiff))} h</div>)}
              </div>)}
              <div className="text-xs text-gray-500">Tip: negative means shortage, positive means exceed. Supports HH:MM.</div>
            </div>
          </div>
        </div>
        <div className="bg-white rounded-2xl shadow p-4">
          <div className="flex items-center justify-between mb-3"><h3 className="font-semibold">Daily entries (Sun–Thu)</h3><div className="text-xs text-gray-500">Enter hours (e.g., 8, 7.5). Friday & Saturday are excluded.</div></div>
          <div className="grid grid-cols-5 gap-2 text-sm">
            {WORKING_WEEK.map(wd => (<div key={wd} className="text-center font-medium text-gray-600">{wd}</div>))}
            {(() => {
              const rows = []; let currentRow = [null,null,null,null,null];
              for (let d=1; d<=totalDays; d++){ const dt=new Date(year,month,d); const wd=dt.getDay(); if (wd===5||wd===6) continue;
                const col = wd===0?0:wd;
                if (col===0 && currentRow.some(c=>c!==null)){ rows.push(currentRow); currentRow=[null,null,null,null,null]; }
                currentRow[col]=d;
                if (col===4){ rows.push(currentRow); currentRow=[null,null,null,null,null]; }
              }
              if (currentRow.some(c=>c!==null)) rows.push(currentRow);
              return rows.flatMap((r,i)=> r.map((dayNum,j)=>(<div key={`r${i}c${j}`} className="rounded-xl border p-2 bg-white">
                {dayNum ? (<>
                  <div className="flex items-center justify-between mb-2"><span className="text-xs text-gray-500">{dayNum}</span></div>
                  <input type="number" step={0.25} min={0} className="w-full rounded-lg border px-2 py-1" placeholder="—"
                    value={hoursByDay[dayNum] ?? ""}
                    onChange={(e)=>{
                      const v = e.target.value === "" ? NaN : Number(e.target.value);
                      setHoursByDay(prev => { const next={...prev}; if (isNaN(v)) delete next[dayNum]; else next[dayNum]=v; return next; });
                    }}
                  />
                </>) : (<div className="h-7" />)}
              </div>)))
            })()}
          </div>
        </div>
        <footer className="text-xs text-gray-500 mt-6 text-center">Data stays in your browser. Fixed Qatar weekend (Fri+Sat). Daily target fixed at 8 hours.</footer>
      </div></div>);
    }
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
